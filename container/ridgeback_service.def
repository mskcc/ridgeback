Bootstrap: docker
From: ubuntu:18.04
Includecmd: no

%post
    echo "Building from branch $RIDGEBACK_BRANCH"

    export DEBIAN_FRONTEND=noninteractive \
    && apt-get clean && apt-get update -qq \
    && apt-get -y install \
        python python-pip python-dev python3 python3-pip python3-virtualenv wget \
        libldap2-dev libsasl2-dev libssl-dev libxml2-dev libxslt-dev \
        postgresql postgresql-contrib libpq-dev \
        gawk build-essential nodejs \
        git \
        default-jdk

    cd /usr/bin \
    && git clone https://github.com/mskcc/ridgeback --branch $RIDGEBACK_BRANCH
    cd /usr/bin/ridgeback \
    && python3 -m pip install python-ldap \
    && pip3 install Cython \
    && pip3 install scikit-build \
    && pip3 install setuptools==57.5.0 \
    && pip3 install -r requirements.txt \
    && pip3 install -r requirements-toil.txt


##############################
# run ridgeback service
##############################

%startscript

    if [ -z "$RIDGEBACK_PATH" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_PATH is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_PORT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_PORT is not set."
        exit 1
    fi

    ### Required envs to connect with postgres db
    if [ -z "$RIDGEBACK_DB_NAME" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_DB_NAME is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_DB_USERNAME" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_DB_USERNAME is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_DB_PASSWORD" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_DB_PASSWORD is not set."
        exit 1
    fi

    ### Required envs to establish toil
    if [ -z "$RIDGEBACK_TOIL_JOB_STORE_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_TOIL_JOB_STORE_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_TOIL_WORK_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_TOIL_WORK_DIR_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_TOIL_TMP_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_TOIL_TMP_DIR_ROOT is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_TOIL" ]; then
        export RIDGEBACK_TOIL=`python3 -c "import os; print(os.path.join('$RIDGEBACK_VENV','bin/cwltoil'))"`
        echo "RIDGEBACK_TOIL set to $RIDGEBACK_TOIL"
    fi

    ### Required envs to establish nextflow
    if [ -z "$RIDGEBACK_NEXTFLOW_JOB_STORE_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_NEXTFLOW_JOB_STORE_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_NEXTFLOW_WORK_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_NEXTFLOW_WORK_DIR_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_NEXTFLOW_TMP_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_NEXTFLOW_TMP_DIR_ROOT is not set."
        exit 1
    fi

    ### LSF Parameters to communicate with LSF
    if [ -z "$RIDGEBACK_LSF_WALLTIME" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_LSF_WALLTIME not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_LSF_SLA" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_LSF_SLA not set."
        exit 1
    fi

    if [ -z "$LSF_ENVDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_ENVDIR is not set."
        exit 1
    fi

    if [ -z "$LSF_BINDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_BINDIR is not set."
        exit 1
    fi

    if [ -z "$LSF_LIBDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_LIBDIR is not set."
        exit 1
    fi

    if [ -z "$LSF_SERVERDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_SERVERDIR is not set."
        exit 1
    fi

    python3 ${RIDGEBACK_PATH}/manage.py migrate
    yes | python3 ${RIDGEBACK_PATH}/manage.py collectstatic
    DD_SERVICE="ridgeback" DD_ENV="dev" DD_LOGS_INJECTION=true DD_TRACE_SAMPLE_RATE="1" DD_PROFILING_ENABLED=true ddtrace-run python3 ${RIDGEBACK_PATH}/manage.py runserver 0.0.0.0:$RIDGEBACK_PORT > /dev/null 2>&1 < /dev/null &
