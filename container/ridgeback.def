Bootstrap: docker
From: ubuntu:18.04
Includecmd: no

%post
    export DEBIAN_FRONTEND=noninteractive \
    && apt-get clean && apt-get update -qq \
    && apt-get -y install \
        python python-pip python-dev python3 python3-pip python3-virtualenv wget \
        libldap2-dev libsasl2-dev libssl-dev \
        postgresql postgresql-contrib libpq-dev \
        gawk build-essential nodejs \
        git \
        default-jdk

    if [ -z "$RIDGEBACK_BRANCH" ]; then
    export RIDGEBACK_BRANCH=master
    fi

    cd /usr/bin \
    && git clone https://github.com/mskcc/ridgeback --branch $RIDGEBACK_BRANCH
    cd /usr/bin/ridgeback \
    && python3 -m pip install python-ldap \
    && pip3 install toil==3.21.0 \
    && pip3 install -r requirements.txt


##############################
# run ridgeback service
##############################

%apprun ridgeback-start

    if [ -z "$RIDGEBACK_PATH" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_PATH is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_PORT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_PORT is not set."
        exit 1
    fi

    ### Required envs to connect with postgres db
    if [ -z "$RIDGEBACK_DB_NAME" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_DB_NAME is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_DB_USERNAME" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_DB_USERNAME is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_DB_PASSWORD" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_DB_PASSWORD is not set."
        exit 1
    fi

    ### Required envs to establish toil
    if [ -z "$RIDGEBACK_TOIL_JOB_STORE_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_TOIL_JOB_STORE_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_TOIL_WORK_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_TOIL_WORK_DIR_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_TOIL_TMP_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_TOIL_TMP_DIR_ROOT is not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_TOIL" ]; then
        export RIDGEBACK_TOIL=`python3 -c "import os; print(os.path.join('$RIDGEBACK_VENV','bin/cwltoil'))"`
        echo "RIDGEBACK_TOIL set to $RIDGEBACK_TOIL"
    fi

    ### Required envs to establish nextflow
    if [ -z "$RIDGEBACK_NEXTFLOW_JOB_STORE_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_NEXTFLOW_JOB_STORE_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_NEXTFLOW_WORK_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_NEXTFLOW_WORK_DIR_ROOT is not setr."
        exit 1
    fi

    if [ -z "$RIDGEBACK_NEXTFLOW_TMP_DIR_ROOT" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_NEXTFLOW_TMP_DIR_ROOT is not set."
        exit 1
    fi

    ### LSF Parameters to communicate with LSF
    if [ -z "$RIDGEBACK_LSF_WALLTIME" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_LSF_WALLTIME not set."
        exit 1
    fi

    if [ -z "$RIDGEBACK_LSF_SLA" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_LSF_SLA not set."
        exit 1
    fi

    if [ -z "$LSF_ENVDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_ENVDIR is not set."
        exit 1
    fi

    if [ -z "$LSF_BINDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_BINDIR is not set."
        exit 1
    fi

    if [ -z "$LSF_LIBDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_LIBDIR is not set."
        exit 1
    fi

    if [ -z "$LSF_SERVERDIR" ]; then
        echo "ERROR: SINGULARITYENV_LSF_SERVERDIR is not set."
        exit 1
    fi

    python3 ${RIDGEBACK_PATH}/manage.py migrate
    python3 ${RIDGEBACK_PATH}/manage.py collectstatic
    python3 ${RIDGEBACK_PATH}/manage.py runserver 0.0.0.0:$RIDGEBACK_PORT > /dev/null 2>&1 < /dev/null &

##############################
# start celery
##############################

%apprun celery-start

    ### General env variables
    if [ -z "$RIDGEBACK_VENV" ]; then
        echo "ERROR environment variable SINGULARITYENV_RIDGEBACK_VENV is not defined, Toil will not work"
        exit 1
    fi

    if [ -z "$SINGULARITY_PATH" ]; then
        echo "ERROR environment variable SINGULARITYENV_SINGULARITY_PATH is not defined, Singularity will not work"
        exit 1
    fi

    if [ -z "$RIDGEBACK_PATH" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_PATH is not set."
        exit 1
    fi

    if [ -z "RIDGEBACK_TOIL" ]; then
        echo "ERROR environment variable SINGULARITYENV_RIDGEBACK_TOIL is not defined, Toil on LSF will not work"
        exit 1
    fi

    ### rabbitmq queue variables
    if [ -z "RIDGEBACK_CHECK_STATUS_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CHECK_STATUS_QUEUE is not defined"
        exit 1
    fi
    
    if [ -z "RIDGEBACK_CHECK_STATUS_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_ACTION_QUEUE is not defined"
        exit 1
    fi

    if [ -z "RIDGEBACK_CLEANUP_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CLEANUP_QUEUE is not defined"
        exit 1
    fi
    
    if [ -z "RIDGEBACK_SUBMIT_JOB_LSF_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_SUBMIT_JOB_LSF_QUEUE is not defined"
        exit 1
    fi

    if [ -z "RIDGEBACK_SUBMIT_JOB_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_SUBMIT_JOB_QUEUE is not defined"
        exit 1
    fi

    ### Celery env variables
    if [ -z "${RIDGEBACK_CELERY_LOG_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_LOG_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_PID_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_PID_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX not set."
        exit 1
    fi

    ### LSF env variables
    if [ -z "$LSF_LIBDIR" ]; then
        echo "ERROR environment variable LSF_LIBDIR is not defined, LSF will not work"
        exit 1
    fi

    if [ -z "$LSF_SERVERDIR" ]; then
        echo "ERROR environment variable LSF_SERVERDIR is not defined, LSF will not work"
        exit 1
    fi

    if [ -z "$LSF_ENVDIR" ]; then
        echo "ERROR environment variable LSF_ENVDIR is not defined, LSF will not work"
        exit 1
    fi

    if [ -z "$LSF_BINDIR" ]; then
        echo "ERROR environment variable LSF_BINDIR is not defined, LSF will not work"
        exit 1
    fi

    if [ ! -d "$LSF_LIBDIR" ]; then
        echo "ERROR $LSF_LIBDIR is not mounted or does not exist"
        exit 1
    fi

    if [ ! -d "$LSF_SERVERDIR" ]; then
        echo "ERROR $LSF_SERVERDIR is not mounted or does not exist"
        exit 1
    fi

    if [ ! -d "$LSF_ENVDIR" ]; then
        echo "ERROR $LSF_ENVDIR is not mounted or does not exist"
        exit 1
    fi

    if [ ! -d "$LSF_BINDIR" ]; then
        echo "ERROR $LSF_BINDIR is not mounted or does not exist"
        exit 1
    fi

    export RIDGEBACK_VENV_ACTIVATE=`python3 -c "import os; print(os.path.join('$RIDGEBACK_VENV','bin/activate'))"`
    export SINGULARITY_BIN_PATH=`python3 -c "import os; print(os.path.dirname('$SINGULARITY_PATH'))"`

    . $RIDGEBACK_VENV_ACTIVATE
    export PATH=$LSF_BINDIR:$SINGULARITY_BIN_PATH:$PATH

    nohup celery -A orchestrator beat \
    -l info \
    --workdir ${RIDGEBACK_PATH} \
    -f ${RIDGEBACK_CELERY_LOG_PATH}/ridgeback_beat.log \
    --pidfile ${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.ridgeback_beat.pid \
    -s ${RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.celerybeat-schedule >/dev/null 2>&1 < /dev/null &

    nohup celery -A orchestrator worker \
    -l info \
    --workdir ${RIDGEBACK_PATH} \
    -Q ${RIDGEBACK_SUBMIT_JOB_LSF_QUEUE} \
    -f ${RIDGEBACK_CELERY_LOG_PATH}/${RIDGEBACK_SUBMIT_JOB_LSF_QUEUE}.log \
    --pidfile ${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_SUBMIT_JOB_LSF_QUEUE}.pid \
    --concurrency=10 \
    -n ${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_SUBMIT_JOB_LSF_QUEUE} >/dev/null 2>&1 < /dev/null &

    nohup celery -A orchestrator worker \
    -l info \
    --workdir ${RIDGEBACK_PATH} \
    -Q ${RIDGEBACK_ACTION_QUEUE} \
    -f ${RIDGEBACK_CELERY_LOG_PATH}/${RIDGEBACK_ACTION_QUEUE}.log \
    --pidfile ${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_ACTION_QUEUE}.pid \
    --concurrency=10 \
    -n ${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_ACTION_QUEUE} >/dev/null 2>&1 < /dev/null &

    nohup celery -A orchestrator worker \
    -l info \
    --workdir ${RIDGEBACK_PATH} \
    -Q ${RIDGEBACK_CHECK_STATUS_QUEUE} \
    -f ${RIDGEBACK_CELERY_LOG_PATH}/${RIDGEBACK_CHECK_STATUS_QUEUE}.log \
    --pidfile ${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_CHECK_STATUS_QUEUE}.pid \
    --concurrency=1 >/dev/null 2>&1 < /dev/null &

    nohup celery -A orchestrator worker \
    -l info \
    --workdir ${RIDGEBACK_PATH} \
    -Q ${RIDGEBACK_SUBMIT_JOB_QUEUE} \
    -f ${RIDGEBACK_CELERY_LOG_PATH}/${RIDGEBACK_SUBMIT_JOB_QUEUE}.log \
    --pidfile ${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_SUBMIT_JOB_QUEUE}.pid \
    --concurrency=1 >/dev/null 2>&1 < /dev/null &

    nohup celery -A orchestrator worker \
    -l info \
    --workdir ${RIDGEBACK_PATH} \
    -Q ${RIDGEBACK_CLEANUP_QUEUE} \
    -f ${RIDGEBACK_CELERY_LOG_PATH}/${RIDGEBACK_CLEANUP_QUEUE}.log \
    --pidfile ${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_CLEANUP_QUEUE}.pid \
    --concurrency=2 >/dev/null 2>&1 < /dev/null &


##############################
# stop celery
##############################

%apprun celery-stop
    if [ -z "${RIDGEBACK_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_PATH not set."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_LOG_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_LOG_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_PID_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_PID_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX not set."
        exit 1
    fi

    ### rabbitmq queue variables
    if [ -z "RIDGEBACK_CHECK_STATUS_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CHECK_STATUS_QUEUE is not defined"
        exit 1
    fi
    
    if [ -z "RIDGEBACK_CHECK_STATUS_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_ACTION_QUEUE is not defined"
        exit 1
    fi

    if [ -z "RIDGEBACK_CLEANUP_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CLEANUP_QUEUE is not defined"
        exit 1
    fi
    
    if [ -z "RIDGEBACK_SUBMIT_JOB_LSF_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_SUBMIT_JOB_LSF_QUEUE is not defined"
        exit 1
    fi

    if [ -z "RIDGEBACK_SUBMIT_JOB_QUEUE" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_SUBMIT_JOB_QUEUE is not defined"
        exit 1
    fi

    export RIDGEBACK_CELERY_BEAT_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.ridgeback_beat.pid
    export RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_SUBMIT_JOB_LSF_QUEUE}.pid
    export RIDGEBACK_ACTION_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_ACTION_QUEUE}.pid
    export RIDGEBACK_CHECK_STATUS_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_CHECK_STATUS_QUEUE}.pid
    export RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_SUBMIT_JOB_QUEUE}.pid
    export RIDGEBACK_CLEANUP_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_CLEANUP_QUEUE}.pid

    echo "Killing celery services with the following settings:"
    echo "RIDGEBACK_PATH:"$RIDGEBACK_PATH
    echo "RIDGEBACK_CELERY_LOG_PATH:"$RIDGEBACK_CELERY_LOG_PATH
    echo "RIDGEBACK_CELERY_PID_PATH:"$RIDGEBACK_CELERY_PID_PATH
    echo "RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH:"$RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH
    echo "RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX:"$RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX
    echo "RIDGEBACK_CELERY_BEAT_PID_FILE:"$RIDGEBACK_CELERY_BEAT_PID_FILE
    echo "RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE:"$RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE
    echo "RIDGEBACK_ACTION_PID_FILE:"$RIDGEBACK_ACTION_PID_FILE
    echo "RIDGEBACK_CHECK_STATUS_QUEUE_PID_FILE:"$RIDGEBACK_CHECK_STATUS_QUEUE_PID_FILE
    echo "RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE:"$RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE
    echo "RIDGEBACK_CLEANUP_QUEUE_PID_FILE:"$RIDGEBACK_CLEANUP_QUEUE_PID_FILE

    ps auxww | grep 'celery' | grep $RIDGEBACK_CELERY_BEAT_PID_FILE | grep -v 'grep' | awk '{print $2}' | xargs kill -9
    ps auxww | grep 'celery' | grep $RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | xargs kill -9
    ps auxww | grep 'celery' | grep $RIDGEBACK_ACTION_PID_FILE | grep -v 'grep' | awk '{print $2}' | xargs kill -9
    ps auxww | grep 'celery' | grep $RIDGEBACK_CHECK_STATUS_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | xargs kill -9
    ps auxww | grep 'celery' | grep $RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | xargs kill -9
    ps auxww | grep 'celery' | grep $RIDGEBACK_CLEANUP_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | xargs kill -9

############################################################
# check env variables with celery-env
# 
# view how many processes are running for each celery worker
############################################################

%apprun celery-env
    if [ -z "${RIDGEBACK_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_PATH not set."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_LOG_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_LOG_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_PID_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_PID_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH not set; suggest setting to default /tmp, accessible by container."
        exit 1
    fi

    if [ -z "${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}" ]; then
        echo "ERROR: SINGULARITYENV_RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX not set."
        exit 1
    fi
 

    export RIDGEBACK_CELERY_BEAT_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.ridgeback_beat.pid
    export RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_SUBMIT_JOB_LSF_QUEUE}.pid
    export RIDGEBACK_ACTION_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_ACTION_QUEUE}.pid
    export RIDGEBACK_CHECK_STATUS_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_CHECK_STATUS_QUEUE}.pid
    export RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_SUBMIT_JOB_QUEUE}.pid
    export RIDGEBACK_CLEANUP_QUEUE_PID_FILE=${RIDGEBACK_CELERY_PID_PATH}/${RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX}.${RIDGEBACK_CLEANUP_QUEUE}.pid

    echo "Current celery settings:"
    echo "RIDGEBACK_PATH:"$RIDGEBACK_PATH
    echo "RIDGEBACK_CELERY_LOG_PATH:"$RIDGEBACK_CELERY_LOG_PATH
    echo "RIDGEBACK_CELERY_PID_PATH:"$RIDGEBACK_CELERY_PID_PATH
    echo "RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH:"$RIDGEBACK_CELERY_BEAT_SCHEDULE_PATH
    echo "RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX:"$RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX
    echo "RIDGEBACK_CELERY_BEAT_PID_FILE:"$RIDGEBACK_CELERY_BEAT_PID_FILE
    echo "RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE:"$RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE
    echo "RIDGEBACK_ACTION_PID_FILE:"$RIDGEBACK_ACTION_PID_FILE
    echo "RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE:"$RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE
    echo "RIDGEBACK_CLEANUP_QUEUE_PID_FILE:"$RIDGEBACK_CLEANUP_QUEUE_PID_FILE
    echo ""

    export RIDGEBACK_CELERY_BEAT=`ps auxww | grep 'celery' | grep $RIDGEBACK_CELERY_BEAT_PID_FILE | grep -v 'grep' | awk '{print $2}' | wc -l`
    export RIDGEBACK_SUBMIT_JOB_LSF_QUEUE=`ps auxww | grep 'celery' | grep $RIDGEBACK_SUBMIT_JOB_LSF_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | wc -l`
    export RIDGEBACK_ACTION_QUEUE=`ps auxww | grep 'celery' | grep $RIDGEBACK_ACTION_PID_FILE | grep -v 'grep' | awk '{print $2}' | wc -l`
    export RIDGEBACK_CHECK_STATUS_QUEUE=`ps auxww | grep 'celery' | grep $RIDGEBACK_CHECK_STATUS_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | wc -l`
    export RIDGEBACK_SUBMIT_JOB_QUEUE=`ps auxww | grep 'celery' | grep $RIDGEBACK_SUBMIT_JOB_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | wc -l`
    export RIDGEBACK_CLEANUP_QUEUE=`ps auxww | grep 'celery' | grep $RIDGEBACK_CLEANUP_QUEUE_PID_FILE | grep -v 'grep' | awk '{print $2}' | wc -l`

    echo "Number of celery processes currently running for $RIDGEBACK_CELERY_EVENT_QUEUE_PREFIX:"
    echo "Beat - $RIDGEBACK_CELERY_BEAT"
    echo "Submit job lsf queue - $RIDGEBACK_SUBMIT_JOB_LSF_QUEUE"
    echo "Action queue - $RIDGEBACK_ACTION_QUEUE"
    echo "Submit job queue - $RIDGEBACK_SUBMIT_JOB_QUEUE"
    echo "Cleanup queue - $RIDGEBACK_CLEANUP_QUEUE"
